---
title: "metapsyTools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{metapsyTools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introducing metapsyTools

The `metapsy` package aims to faciliate the calculation of effect size data based on the metapsy database (https://evidencebasedpsychotherapies.shinyapps.io/metapsy/). For its optimal use, all included functions are used in combination. The three functions are intended to format the imported data in a way that effect sizes can be calculated in R for all trials and comparisons. Then, these effect size data can be pooled to get one overall effect size estimation.

## Characteristics of the metapsy data
When working with imported data of the metapsy database in R, there are a few points to keep in mind:

* The data is organized in a specific way: study specific information span multiple rows that can differ in their outcomes (primary or not), their conditions, arms and so on (similar to the long format in R). 

* However, it differs notably from the long format in one point that is especially relevant for effect size calculation: In multiarm studies, not all intervention groups have a clearly assignable control group, which is required for effect size calculation in R.

We can see this for example in the study of Hauksson (2017): This is a three-arm study that compares two interventions ("grp" and "ind") against a control group (resulting in three rows for the primary outcome). In R, this format is too ambiguous to calculate effect sizes of it.

```{r, echo=FALSE}
library(metapsyTools)

inpatients %>% 
  dplyr::filter(study=="Hauksson, 2017" & primary==1) %>% 
  dplyr::select(1:8,)
```


## Workflow
This structure is particulary important to unterstand the functioning of the `metapsyTools`-package. It provides tools to:

* check the data format at first and
* convert multiarm trials in the dataset to a format that allows effect size calculation for all comparisons. 

### Introducing the 'pipe'
For this purpose, it is highly suggested to combine all three functions with a `pipe` operator. This is a helpful tool that basically allows users to run several functions on one object in R in a very understandable way.

Instead of nesting functions it processes an object using a sequence of operations by passing the result of one step as input for the next step. For the `metapsy` package it means that each function can be applied on a meta- dataset in one run and we don`t have to create intermediate objects or go through the process step by step to get the required effect size data:

```{r, eval=FALSE}
inpatients %>% 
  checkDataFormat() %>% 
  expandMultiarmTrials() %>% 
  calculateEffectSizes()
```

This code uses the 'inpatients' example dataset to be checked at first, then the multiarm study rows are expanded and finally effect sizes are calculated for each comparison. 

**_NOTE:_** Importantly, the use of pipes is just a suggestion to save time, each of the functions can be applied separately as well.

We can now filter for example for a specific study and outcome and inspect the effect sizes.

```{r }
inpatients %>% 
  checkDataFormat() %>% 
  expandMultiarmTrials() %>% 
  calculateEffectSizes() %>% 
  dplyr::filter(study.id == "Hauksson, 2017" & primary==1) %>% 
  dplyr::select(c("study", "es", "se", "condition", "multiple_arms", "primary", "no.arms"))
```


When we inspect the effect sizes for the primary outome in the Hauksson (2017) study, we see that `expandMultiarmTrials` duplicated rows to obtain pairwise comparisons for the control vs. intervention group for both interventions. 

## pooling effect sizes

As described, it is now possible to pool the effect sizes to get an overall estimation. Therefore, the effect sizes must be filtered so that effect sizes over all studies compare the relevant (e.g. primary) outcome only. Missings at the effect size variable must be filtered as well, as effect size per comparison are stored in one row (and the other as missing). The `metagen` function allows to specify some arguments for effect size pooling that might be customized. 

```{r}
library(meta)

inpatients %>% 
  checkDataFormat %>% 
  expandMultiarmTrials %>% 
  calculateEffectSizes %>% 
  dplyr::filter(!is.na(es) & primary==1) %>% 
  metagen(es, se, studlab=study, comb.fixed=FALSE, data=.)
```




